package com.example.demo.controller;

import com.example.demo.dto.*;
import com.example.demo.bean.*;
import com.example.demo.service.*;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;
import java.util.List;

@RestController
@RequestMapping("/insurance")
public class InsuranceController {

    @Autowired private InsuranceService service;
    // 1. UPDATE ENDPOINT
    @PutMapping("/update/{id}")
    public ResponseEntity<Policy> updatePolicy(@PathVariable Long id, @RequestBody PolicyDTO policyDTO) {
        Policy updatedPolicy = insuranceService.updatePolicy(id, policyDTO);
        return ResponseEntity.ok(updatedPolicy);
    }

    // 2. DELETE ENDPOINT
    @DeleteMapping("/delete/{id}")
    public ResponseEntity<String> deletePolicy(@PathVariable Long id) {
        insuranceService.deletePolicy(id);
        return ResponseEntity.ok("Policy deleted successfully");
    }
    @PostMapping("/upload-card")
    public ResponseEntity<InsuranceCard> uploadCard(
            @RequestParam("file") MultipartFile file,
            @RequestHeader(value = "Authorization", required = false) String token) {
        try {
            // For Phase 3 testing, we hardcode userId = 1.
            // In a full environment, the Gateway would pass the user ID.
            Long userId = 1L; 
            return ResponseEntity.accepted().body(service.processCardUpload(file, userId));
        } catch (Exception e) {
            return ResponseEntity.internalServerError().build();
        }
    }

    @PostMapping("/manual-entry")
    public ResponseEntity<InsuranceCard> manualEntry(
            @RequestBody ManualEntryRequest request,
            @RequestHeader(value = "Authorization", required = false) String token) {
        Long userId = 1L; 
        return ResponseEntity.ok(service.saveManualPolicy(request, userId));
    }

    @GetMapping("/list")
    public List<InsuranceCard> listPolicies(@RequestHeader(value = "Authorization", required = false) String token) {
        Long userId = 1L;
        return service.getUserPolicies(userId);
    }
}
