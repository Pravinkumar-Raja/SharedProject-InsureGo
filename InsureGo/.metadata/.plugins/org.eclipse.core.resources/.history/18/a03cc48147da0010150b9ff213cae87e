package com.example.demo.service;

import com.example.demo.bean.InsuranceCard;
import com.example.demo.dto.ManualEntryRequest;
import com.example.demo.repository.InsuranceRepository;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import java.time.LocalDate;
import java.util.List;

@Service
public class InsuranceService {

    @Autowired
    private InsuranceRepository repository; // Ensure this matches your Repository Class Name

    // --- MANUAL ENTRY (Fixes the 500 Error) ---
    public InsuranceCard saveManualPolicy(ManualEntryRequest request, Long userId) {
        InsuranceCard card = new InsuranceCard();
        
        // 1. Core Mapping
        card.setPolicyNumber(request.getPolicyNumber()); 
        card.setInsuranceProvider(request.getInsuranceProvider());
        card.setPolicyName(request.getPolicyName());
        card.setCoverageAmount(request.getCoverageAmount());
        card.setUserId(userId);
        card.setStatus("ACTIVE");

        // 2. --- CRITICAL: Save Patient Name ---
        // This allows the card to belong to a family member (e.g. "John Doe's Child")
        // If blank, fall back to "Self" or handle logic elsewhere
        card.setPatientName(request.getPatientName());

        // 3. --- CRITICAL: Save Dates ---
        
        // Set Registered/Issue Date (Default to Today if missing)
        if (request.getRegisteredDate() != null) {
            card.setIssueDate(request.getRegisteredDate()); // Ensure your Entity has setIssueDate or setStartDate
        } else {
            card.setIssueDate(java.time.LocalDate.now());
        }

        // Set Expiry Date (Default to +1 Year if missing)
        if (request.getExpiryDate() != null) {
            card.setExpiryDate(request.getExpiryDate());
        } else {
            card.setExpiryDate(java.time.LocalDate.now().plusYears(1));
        }

        return repository.save(card);
    }

    // --- FILE UPLOAD (Simplified for now to prevent crashes) ---
    public InsuranceCard processCardUpload(MultipartFile file, Long userId) {
        InsuranceCard card = new InsuranceCard();
        card.setUserId(userId);
        card.setStatus(InsuranceCard.Status.PENDING);
        
        // Temporary: We will add the N8n/OCR logic later.
        // For now, just save it so the UI shows "Pending"
        card.setFileUri("http://via.placeholder.com/150"); 
        card.setProvider("Processing...");
        card.setPolicyNumber("PENDING");
        card.setPatientName("Processing...");
        card.setExpiryDate(LocalDate.now().plusYears(1));

        return repository.save(card);
    }
 // --- NEW: UPDATE LOGIC ---
    public InsuranceCard updatePolicy(Long id, InsuranceCard cardDetails) {
        // 1. Find the existing card
        InsuranceCard existingCard = repository.findById(id)
                .orElseThrow(() -> new RuntimeException("Card not found with id: " + id));

        // 2. Update the fields
        existingCard.setProvider(cardDetails.getProvider());
        existingCard.setPolicyNumber(cardDetails.getPolicyNumber());
        existingCard.setPatientName(cardDetails.getPatientName());
        existingCard.setExpiryDate(cardDetails.getExpiryDate());

        // Note: We usually don't update 'id', 'userId', or 'fileUri' during a simple edit

        // 3. Save back to database
        return repository.save(existingCard);
    }

    // --- NEW: DELETE LOGIC ---
    public void deletePolicy(Long id) {
        repository.deleteById(id);
    }
    // --- GET LIST ---
    public List<InsuranceCard> getUserPolicies(Long userId) {
        return repository.findAll(); // In real app: repository.findByUserId(userId)
    }
}