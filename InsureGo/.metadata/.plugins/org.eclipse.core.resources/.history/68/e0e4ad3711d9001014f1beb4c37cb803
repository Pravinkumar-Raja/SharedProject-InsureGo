package com.example.demo.controller;



import com.example.demo.bean.Claim;
import com.example.demo.repository.ClaimRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.time.LocalDate; // Required for Rule Engine
import java.util.List;
import java.util.Optional;

@RestController
@RequestMapping("/claim")
public class ClaimController {

    @Autowired
    private ClaimRepository claimRepository;

    // 1. PATIENT: Initiates the Claim
    @PostMapping("/initiate")
    public ResponseEntity<Claim> initiateClaim(@RequestBody Claim claim) {
        claim.setStatus("OPEN");
        claim.setInsurancePays(0.0);
        claim.setUserPays(0.0);
        claim.setTotalBillAmount(0.0);
        claim.setTreatmentDescription("Pending Doctor Input");
        claim.setDateFiled(LocalDate.now()); // Ensure date is set for duplicate check
        return ResponseEntity.ok(claimRepository.save(claim));
    }

    // 2. DOCTOR: Adds Bill & Treatment (Includes RULE ENGINE) [cite: 92, 97]
    @PutMapping("/doctor-update/{policyNo}")
    public ResponseEntity<?> addMedicalDetails(@PathVariable String policyNo, @RequestBody Claim doctorEntry) {
        
        Optional<Claim> existingClaim = claimRepository.findAll().stream()
            .filter(c -> c.getPolicyNo().equals(policyNo) && c.getStatus().equals("OPEN"))
            .findFirst();

        if (existingClaim.isPresent()) {
            Claim claim = existingClaim.get();
            Double billAmount = doctorEntry.getTotalBillAmount();

            // --- üõ°Ô∏è RULE 1: DUPLICATE BILL CHECK --- [cite: 95]
            boolean isDuplicate = claimRepository.existsByPolicyNoAndTotalBillAmountAndDateFiled(
                policyNo, billAmount, LocalDate.now()
            );

            if (isDuplicate) {
                // Reject immediately if it's a duplicate request from today
                claim.setStatus("REJECTED");
                claim.setTreatmentDescription("System Auto-Rejection: Duplicate Claim Detected");
                claim.setTotalBillAmount(billAmount);
                return ResponseEntity.ok(claimRepository.save(claim));
            }

            // Update Details
            claim.setTotalBillAmount(billAmount);
            claim.setTreatmentDescription(doctorEntry.getTreatmentDescription());

            // --- ‚ö° RULE 2: AUTO-APPROVAL (Fast Track) --- [cite: 77, 97]
            if (billAmount < 500) { 
                // Auto-Approve logic: Claims under $500 get instant approval
                claim.setStatus("APPROVED"); 
                
                // Calculate Split (80% Insurance / 20% User)
                claim.setInsurancePays(billAmount * 0.80);
                claim.setUserPays(billAmount * 0.20);
                
                // Append note so Admin knows it was a Bot
                claim.setTreatmentDescription(claim.getTreatmentDescription() + " (Auto-Approved by System)");
            } 
            else {
                // --- ‚úã RULE 3: MANUAL REVIEW --- [cite: 97]
                // High value claims (> $500) go to Provider
                claim.setStatus("PENDING_APPROVAL"); 
            }

            return ResponseEntity.ok(claimRepository.save(claim));
        }
        return ResponseEntity.status(404).body("No open claim found for this Policy ID");
    }

    // 3. PROVIDER: Approves/Rejects & Calculates Split
    @PutMapping("/verdict/{id}")
    public ResponseEntity<Claim> providerVerdict(@PathVariable Long id, @RequestBody String status) {
        return claimRepository.findById(id).map(claim -> {
            claim.setStatus(status);
            
            if (status.equals("APPROVED")) {
                double total = claim.getTotalBillAmount();
                claim.setInsurancePays(total * 0.80);
                claim.setUserPays(total * 0.20);
            } else {
                claim.setInsurancePays(0.0);
                claim.setUserPays(claim.getTotalBillAmount());
            }
            return ResponseEntity.ok(claimRepository.save(claim));
        }).orElse(ResponseEntity.notFound().build());
    }

    // 4. GET ALL
    @GetMapping("/all")
    public List<Claim> getAllClaims() { return claimRepository.findAll(); }
    
    // 5. GET USER CLAIMS
    @GetMapping("/user/{userId}")
    public List<Claim> getUserClaims(@PathVariable Long userId) { return claimRepository.findByUserId(userId); }
    
 // --- 6. UPLOAD MEDICAL DOCUMENT (Doctor) ---
    @PostMapping("/upload-document/{policyNo}")
    public ResponseEntity<?> uploadMedicalDoc(@PathVariable String policyNo, @RequestParam("file") MultipartFile file) {
        try {
            // 1. Check if the file is empty
            if (file.isEmpty()) {
                return ResponseEntity.badRequest().body("File is empty");
            }

            // 2. Save the file locally (For Demo purposes)
            // In a real app, this goes to AWS S3
            String folder = "uploads/medical-reports/";
            Files.createDirectories(Paths.get(folder)); // Ensure folder exists
            
            String fileName = System.currentTimeMillis() + "_" + file.getOriginalFilename();
            Path path = Paths.get(folder + fileName);
            Files.write(path, file.getBytes());

            // 3. Link file to the Claim
            Optional<Claim> existingClaim = claimRepository.findAll().stream()
                .filter(c -> c.getPolicyNo().equals(policyNo) && !c.getStatus().equals("CLOSED"))
                .findFirst();

            if (existingClaim.isPresent()) {
                Claim claim = existingClaim.get();
                claim.setMedicalDocumentPath(fileName); // Save reference in DB
                claimRepository.save(claim);
                return ResponseEntity.ok("File uploaded successfully: " + fileName);
            }

            return ResponseEntity.status(404).body("No active claim found for this policy.");

        } catch (IOException e) {
            return ResponseEntity.status(500).body("Failed to upload file");
        }
    }
}