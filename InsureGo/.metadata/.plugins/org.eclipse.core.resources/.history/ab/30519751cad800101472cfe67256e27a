package com.example.demo.controller;

import com.insurego.policy.dto.ManualEntryRequest;
import com.insurego.policy.entity.InsuranceCard;
import com.insurego.policy.service.InsuranceService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;
import java.util.List;

@RestController
@RequestMapping("/insurance")
public class InsuranceController {

    @Autowired private InsuranceService service;

    @PostMapping("/upload-card")
    public ResponseEntity<InsuranceCard> uploadCard(
            @RequestParam("file") MultipartFile file,
            @RequestHeader(value = "Authorization", required = false) String token) {
        try {
            // For Phase 3 testing, we hardcode userId = 1.
            // In a full environment, the Gateway would pass the user ID.
            Long userId = 1L; 
            return ResponseEntity.accepted().body(service.processCardUpload(file, userId));
        } catch (Exception e) {
            return ResponseEntity.internalServerError().build();
        }
    }

    @PostMapping("/manual-entry")
    public ResponseEntity<InsuranceCard> manualEntry(
            @RequestBody ManualEntryRequest request,
            @RequestHeader(value = "Authorization", required = false) String token) {
        Long userId = 1L; 
        return ResponseEntity.ok(service.saveManualPolicy(request, userId));
    }

    @GetMapping("/list")
    public List<InsuranceCard> listPolicies(@RequestHeader(value = "Authorization", required = false) String token) {
        Long userId = 1L;
        return service.getUserPolicies(userId);
    }
}
