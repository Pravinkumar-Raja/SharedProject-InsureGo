package com.example.demo.controller;


import com.example.demo.bean.Appointment;
import com.example.demo.repository.AppointmentRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.client.RestTemplate;
import java.util.*;

@RestController
@RequestMapping("/dashboard")
public class DashboardController {

    @Autowired
    private AppointmentRepository appointmentRepo;

    @Autowired
    private RestTemplate restTemplate;

    @GetMapping("/doctor-stats/{doctorId}")
    public Map<String, Object> getDoctorStats(@PathVariable Long doctorId) {
        Map<String, Object> stats = new HashMap<>();

        // 1. LOCAL DATA: Get Appointments from OWN Database
        List<Appointment> appts = appointmentRepo.findByDoctorID(doctorId);
        
        long completedAppts = appts.stream().filter(a -> "COMPLETED".equals(a.getStatus())).count();
        stats.put("totalPatients", completedAppts);

        // 2. REMOTE DATA: Call Claims Service for Revenue
        // Assuming Claims Service runs on port 8082
        String claimsServiceUrl = "http://localhost:8082/claim/doctor-stats/General"; 
        
        try {
            // We ask the Claims Service for the numbers
            Map<String, Object> claimData = restTemplate.getForObject(claimsServiceUrl, Map.class);
            
            stats.put("totalRevenue", claimData.get("revenue"));
            stats.put("approvalRate", claimData.get("approvalRate"));
            
        } catch (Exception e) {
            // If Claims Service is down, show 0 to avoid crashing
            stats.put("totalRevenue", 0.0);
            stats.put("approvalRate", 0);
            System.err.println("Could not fetch claims data: " + e.getMessage());
        }

        // 3. GRAPH DATA (Mocked for now)
        List<Map<String, Object>> graphData = new ArrayList<>();
        graphData.add(Map.of("name", "Jan", "visits", 12));
        graphData.add(Map.of("name", "Feb", "visits", 19));
        graphData.add(Map.of("name", "Mar", "visits", 8));
        graphData.add(Map.of("name", "Apr", "visits", (int)completedAppts)); 
        stats.put("graphData", graphData);

        // 4. REVIEWS (Mocked)
        List<Map<String, String>> reviews = new ArrayList<>();
        reviews.add(Map.of("patient", "Alice", "rating", "⭐⭐⭐⭐⭐", "comment", "Great experience!"));
        reviews.add(Map.of("patient", "Bob", "rating", "⭐⭐⭐⭐", "comment", "Very professional."));
        stats.put("reviews", reviews);

        return stats;
    }
}
