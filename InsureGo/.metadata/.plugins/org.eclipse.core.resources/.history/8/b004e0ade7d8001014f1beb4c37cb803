package com.example.demo.service;

import com.example.demo.dto.*;
import com.example.demo.bean.*;
import com.example.demo.repository.*;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.core.io.ByteArrayResource;
import org.springframework.http.*;
import org.springframework.stereotype.Service;
import org.springframework.util.LinkedMultiValueMap;
import org.springframework.util.MultiValueMap;
import org.springframework.web.client.RestTemplate;
import org.springframework.web.multipart.MultipartFile;
import org.springframework.web.server.ResponseStatusException;

import java.time.LocalDate;
import java.time.format.DateTimeParseException;
import java.util.List;

@Service
public class InsuranceService {

    @Autowired private InsuranceRepository repository;
    @Autowired private StorageService storageService;
    @Autowired private RestTemplate restTemplate;

    @Value("${n8n.webhook.url}") private String n8nWebhookUrl;
    @Value("${n8n.auth.user}") private String n8nUser;
    @Value("${n8n.auth.pass}") private String n8nPass;

    // Helper Record for parsing n8n JSON response
    private record N8nResponse(String policyNumber, String provider, String expiryDate, String patientName) {}

    public InsuranceCard processCardUpload(MultipartFile file, Long userId) throws Exception {
        InsuranceCard card = new InsuranceCard();
        card.setUserId(userId);
        card.setStatus(InsuranceCard.Status.PENDING);
        card = repository.save(card);

        try {
            // 1. Prepare Request to n8n
            HttpHeaders headers = new HttpHeaders();
            headers.setBasicAuth(n8nUser, n8nPass);
            headers.setContentType(MediaType.MULTIPART_FORM_DATA);

            MultiValueMap<String, Object> body = new LinkedMultiValueMap<>();
            body.add("file", new ByteArrayResource(file.getBytes()) {
                @Override public String getFilename() { return file.getOriginalFilename(); }
            });

            // 2. Call n8n Synchronously
            ResponseEntity<N8nResponse> response = restTemplate.postForEntity(
                n8nWebhookUrl, new HttpEntity<>(body, headers), N8nResponse.class
            );

            // 3. Process Response
            if (response.getStatusCode() == HttpStatus.OK && response.getBody() != null) {
                N8nResponse data = response.getBody();
                
                String fileUri = storageService.storePermanently(file, userId);
                
                card.setPolicyNumber(data.policyNumber());
                card.setProvider(data.provider());
                card.setPatientName(data.patientName());
                card.setFileUri(fileUri);
                
                // Parse Date safely
                try {
                    card.setExpiryDate(LocalDate.parse(data.expiryDate()));
                } catch (Exception e) {
                    System.err.println("Date parse error: " + data.expiryDate());
                }
                
                card.setStatus(InsuranceCard.Status.COMPLETE);
                return repository.save(card);
            } else {
                card.setStatus(InsuranceCard.Status.EXTRACTION_FAILED);
                return repository.save(card);
            }
        } catch (Exception e) {
            card.setStatus(InsuranceCard.Status.EXTRACTION_FAILED);
            repository.save(card);
            throw new ResponseStatusException(HttpStatus.BAD_GATEWAY, "Automation Service Failed", e);
        }
    }

    public InsuranceCard saveManualPolicy(ManualEntryRequest request, Long userId) {
        InsuranceCard card = new InsuranceCard();
        card.setUserId(userId);
        card.setPolicyNumber(request.getPolicyNumber());
        card.setProvider(request.getProvider());
        card.setPatientName(request.getPatientName());
        try {
            card.setExpiryDate(LocalDate.parse(request.getExpiryDate()));
        } catch (DateTimeParseException e) {
            throw new ResponseStatusException(HttpStatus.BAD_REQUEST, "Invalid Date Format (Use YYYY-MM-DD)");
        }
        card.setStatus(InsuranceCard.Status.COMPLETE);
        card.setFileUri("MANUAL_ENTRY");
        return repository.save(card);
    }
    
    public List<InsuranceCard> getUserPolicies(Long userId) {
        return repository.findByUserId(userId);
    }
}
